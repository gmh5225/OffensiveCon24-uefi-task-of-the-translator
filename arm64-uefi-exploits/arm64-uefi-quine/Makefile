GNUEFIDIR="../gnu-efi"
ARCH="aarch64"

all: uefiquinearm64.efi

%.efi: %.so
	objcopy -j .text -j .sdata -j .data -j .rodata -j .dynamic -j .dynsym  -j .rel -j .rela -j .rel.* -j .rela.* -j .reloc --target efi-app-$(ARCH) --subsystem=10 main.so main.efi

#%.efi: %.so
#	$(OBJCOPY) -j .text -j .sdata -j .data -j .dynamic -j .dynsym -j .rel \
#		    -j .rela -j .rel.* -j .rela.* -j .rel* -j .rela* \
#		    -j .reloc $(FORMAT) $*.so $@

%.efi.debug: %.so
	objcopy -j .debug_info -j .debug_abbrev -j .debug_aranges \
		-j .debug_line -j .debug_str -j .debug_ranges \
		-j .note.gnu.build-id \
		$(ARCH) $*.so $@

%.so: %.o:
	ld -nostdlib -shared -Bsymbolic -L$GNUEFIDIR/$(ARCH)/lib -L$GNUEFIDIR/$(ARCH)/gnuefi -T$GNUEFIDIR/gnuefi/elf_$(ARCH)_efi.lds $GNUEFIDIR/$(ARCH)/gnuefi/crt0-efi-$(ARCH).o main.o -o main.so -lgnuefi -lefi


%.o:%.S: 
	-I$GNUEFIDIR/inc -marm -fPIE -Wall -Wextra -Wno-pointer-sign -Werror -fpic -ffreestanding -fno-stack-protector -fno-stack-check -fshort-wchar -c $< -o $@

